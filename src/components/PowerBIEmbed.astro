---
interface Props {
  reportUrl: string;
}

const { reportUrl } = Astro.props;
---

<div class="embed-area">
  <iframe
    id="reportFrame"
    class="report-frame"
    src={reportUrl}
    allowfullscreen
    title="Power BI Report"
  ></iframe>

  <div class="footer" role="contentinfo">
    <div>
      Si el informe no se muestra, puede estar bloqueado para incrustación por la configuración del informe.
      Pulsa <a class="link" id="openLink" href="#" target="_blank" rel="noopener">Abrir en Power BI</a>.
    </div>
    <div style="opacity:0.9">Diseño sobrio • Power BI</div>
  </div>
</div>

<style>
  .embed-area{
    height:72vh;
    min-height:520px;
    max-height:94vh;
    background:linear-gradient(180deg, transparent, rgba(0,0,0,0.01));
    display:flex;
    flex-direction:column;
  }

  iframe.report-frame{
    width:100%;
    height:100%;
    border:0;
    display:block;
    background:white;
  }

  .footer{
    padding:12px 18px;
    font-size:13px;
    color:var(--muted);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    border-top:1px solid rgba(15,23,42,0.03);
  }

  a.link{
    color:var(--accent);
    text-decoration:none;
    font-weight:600;
  }

  a.link:hover{
    text-decoration:underline;
  }

  @media (max-width:720px){
    .embed-area{ min-height:420px; }
    .footer{
      flex-direction:column;
      align-items:flex-start;
      font-size:12px;
    }
  }
</style>

<script>
  const frame = document.getElementById('reportFrame') as HTMLIFrameElement;
  const openBtn = document.getElementById('btnOpen') as HTMLButtonElement;
  const refreshBtn = document.getElementById('btnRefresh') as HTMLButtonElement;
  const fsBtn = document.getElementById('btnFullscreen') as HTMLButtonElement;
  const openLink = document.getElementById('openLink') as HTMLAnchorElement;
  const reportUrl = frame?.src || '';

  // Botón abrir en nueva pestaña
  if (openBtn) {
    openBtn.addEventListener('click', () => {
      window.open(reportUrl, '_blank', 'noopener');
    });
  }

  if (openLink) {
    openLink.setAttribute('href', reportUrl);
  }

  // Recargar iframe
  if (refreshBtn && frame) {
    refreshBtn.addEventListener('click', () => {
      refreshBtn.textContent = 'Recargando...';
      setTimeout(() => {
        frame.src = reportUrl;
        refreshBtn.textContent = 'Recargar';
      }, 200);
    });
  }

  // Pantalla completa
  if (fsBtn && frame) {
    fsBtn.addEventListener('click', async () => {
      try {
        if (frame.requestFullscreen) {
          await frame.requestFullscreen();
        } else if ((frame as any).webkitRequestFullscreen) {
          await (frame as any).webkitRequestFullscreen();
        } else if ((frame as any).msRequestFullscreen) {
          await (frame as any).msRequestFullscreen();
        }
      } catch (e) {
        console.warn('No se pudo solicitar pantalla completa:', e);
      }
    });
  }

  // Mensaje informativo si el iframe no carga
  let loadTimed = false;
  const loadTimeout = setTimeout(() => {
    loadTimed = true;
    const footer = document.querySelector('.footer > div:first-child');
    if (footer) {
      footer.innerHTML = 'Si el informe no se muestra, es posible que la política de compartición/incrustación del informe lo impida. ' +
                         '<a class="link" href="' + reportUrl + '" target="_blank" rel="noopener">Abrir en Power BI</a>.';
    }
  }, 5000);

  if (frame) {
    frame.addEventListener('load', () => {
      clearTimeout(loadTimeout);
      if (!loadTimed) return;
      const footer = document.querySelector('.footer > div:first-child');
      if (footer) {
        footer.innerHTML = 'Informe cargado. Si hay problemas con permisos, abra el informe en Power BI: ' +
                           '<a class="link" href="' + reportUrl + '" target="_blank" rel="noopener">Abrir en Power BI</a>.';
      }
    });
  }
</script>
